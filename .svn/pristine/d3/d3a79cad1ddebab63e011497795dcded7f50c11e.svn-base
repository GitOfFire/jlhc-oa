package com.jlhc.web.controller;

import com.jlhc.common.dto.Msg;
import com.jlhc.common.utils.ResultUtil;
import com.jlhc.oa.dto.user.User;
import com.jlhc.sell.dto.Note;
import com.jlhc.sell.service.NoteServcie;
import org.apache.shiro.authz.annotation.RequiresPermissions;
import org.apache.shiro.authz.annotation.RequiresUser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpSession;
import javax.validation.constraints.Max;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;
import java.util.List;

@RestController
@RequestMapping("/note")
public class SellNoteController extends BaseController {
    @Autowired
    NoteServcie noteServcie;

    /**
     * 添加一条记录
     *
     * @param httpSession
     * @return
     */
    @PostMapping("postNote")
    @RequiresPermissions("note:postNote")
    public Msg postNote(@RequestParam @NotNull @Size(min = 32,max = 32,message = "代理主键为32位全球唯一码")String taskId,
                        @RequestParam @NotNull @Size(min =1,max = 255,message = "内容不能为空,且内容长度不能超过255个字") String noteContent,
                        HttpSession httpSession){
        try{
            Integer resultNum = 0;
            User user = (User)httpSession.getAttribute("user");
            resultNum += noteServcie.createPost(taskId,noteContent,user.getUserId());
            if ( 0 == resultNum ){
                return ResultUtil.operationFailed("添加了"+resultNum+"条工作记录");
            }
            return ResultUtil.addSuccess(resultNum);
        }catch(Exception e){
            return errorResultOperation(e);
        }
    }

    /**
     * 查询某一任务的工作记录
     *
     * @param taskId
     * @return
     */
    @RequestMapping("getNotesByTaskId")
    @RequiresPermissions("note:getNotesByTaskId")
    public Msg getNotesByTaskId(@RequestParam @NotNull @Size(min = 32,max = 32,message = "代理主键为32位全球唯一码")String taskId){
        try{
            List<Note> notes = noteServcie.queryNotesByTaskId(taskId);
            if (null == notes || 0 == notes.size()){
                return ResultUtil.selectFailed();
            }
            return ResultUtil.selectSuccess(notes);
        }catch(Exception e){
            return errorResultOperation(e);
        }
    }


}
